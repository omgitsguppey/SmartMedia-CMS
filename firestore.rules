rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helpers ---
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Check if the user is attempting to modify restricted fields
    function isModifyingRestrictedFields() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['adminStatus', 'visibility', 'quotaBytes', 'usedBytes']);
    }

    // --- Rules ---

    // User Profiles
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) && !isModifyingRestrictedFields(); // Users can't change their own quota/role

      // User Files
      match /files/{fileId} {
        // Read: Owner, Admin, or Shared (if approved)
        allow read: if isOwner(userId) || isAdmin() || 
                   (resource.data.visibility == 'shared' && resource.data.adminStatus == 'approved');
        
        // Create: Owner only, must set defaults correctly
        allow create: if isOwner(userId)
                      && request.resource.data.adminStatus == 'pending'
                      && request.resource.data.visibility == 'private';
        
        // Update: Owner (metadata only) or Admin (everything)
        allow update: if isAdmin() || (
                        isOwner(userId) 
                        && !isModifyingRestrictedFields()
                      );
                      
        allow delete: if isOwner(userId) || isAdmin();
        
        match /feedback/{feedbackId} {
           allow read: if isOwner(userId) || isAdmin();
           allow write: if isOwner(userId);
        }
      }

      match /prefs/{docId} {
        allow read, write: if isOwner(userId);
      }

      match /settings/{docId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Collection Group Query: 'files'
    match /{path=**}/files/{fileId} {
      allow read: if isAdmin();
    }
  }
}